--执行这一句直接跳过当前流程，每次只跳过一个流程
--定单同步，资源归档，报竣不能跳
DECLARE
  OBJSONBR VARCHAR2(1000) := TRIM('8117031028477412');
  TYPE T__TBL IS TABLE OF WO.WO_NBR%TYPE;

  EVENT      VARCHAR2(1000) := 'WORKITEM_SUCCESS'; --WORKITEM_START
  PROCINSTID VARCHAR2(1000);
  WORKITEMID VARCHAR2(1000);
  WONBR      WO.WO_NBR%TYPE;
  SONBR      SO.SO_NBR%TYPE;
  SUBAREANO  VARCHAR2(2);
  R_ERR      VARCHAR2(1000);
  R_ERR_FLAG VARCHAR2(1000);
  AAA        T__TBL := T__TBL('848727');

BEGIN
  SELECT MAX(W.WO_NBR)
    INTO WONBR
    FROM WO W
   WHERE W.SO_NBR = (SELECT SO.SO_NBR
                       FROM SO
                      WHERE SO.EXT_SO_NBR = OBJSONBR
                        AND SO.STS = 'A')
     AND W.RUN_STS <> 'C'
     AND W.STEP_ID NOT IN ('SC0005');
  BEGIN
    UPDATE WO
       SET WO.RUN_STS = 'C', WO.BUSI_STS = 'N'
     WHERE WO.WO_NBR = WONBR;
    /*SELECT PROC_INST_ID
     INTO PROCINSTID
     FROM WF_PROC_INSTANCE
    WHERE EXT_WORK_ID = OBJSONBR;*/
    SELECT WO.SO_NBR, WO.WORK_ITEM_ID
      INTO SONBR, WORKITEMID
      FROM WO
     WHERE WO.WO_NBR = WONBR;
  
    SELECT PROC_INST_ID
      INTO PROCINSTID
      FROM SO
     WHERE SO.SO_NBR = SONBR
       AND ROWNUM = 1;
  
    SELECT SUBAREA_NO
      INTO SUBAREANO
      FROM WF_PROC_INSTANCE
     WHERE PROC_INST_ID = PROCINSTID;
  
    INSERT INTO T_MS_EVENT_POOL
      (MS_EVENT_ID,
       PROC_INST_ID,
       OBJ_ID,
       OBJ_TYPE,
       OBJ_STATUS,
       EVENT_STR,
       EVENT_PARAM,
       EVENT_TIME,
       EXECUTABLE_TIME,
       EXECUTED_TIME,
       EXCEPT_TIMES,
       EXCEPT_REASON,
       EXECUTE_STATE,
       SUBAREA_NO,
       REALTIME_FLAG)
    VALUES
      (MS_EVENT_ID_SEQ.NEXTVAL,
       PROCINSTID,
       WORKITEMID,
       'WORKITEM',
       'WORKITEM',
       EVENT,
       'OBJ_ID=' || WORKITEMID || ';OBJ_TYPE=WORKITEM;EVENT=' || EVENT || ';',
       SYSDATE,
       SYSDATE,
       SYSDATE,
       0,
       '',
       0,
       SUBAREANO,
       0);
  EXCEPTION
    WHEN OTHERS THEN
      DBMS_OUTPUT.PUT_LINE(WONBR);
  END;
  COMMIT;
END;
